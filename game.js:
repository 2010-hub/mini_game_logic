// –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã
let gameState = {
    mode: 'online',
    online: {
        gameId: null,
        playerChoice: null,
        opponentChoice: null,
        connected: false
    },
    local: {
        player1Choice: null,
        player2Choice: null,
        currentPlayer: 1
    },
    stats: {
        games: 0,
        wins: 0
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function initGame() {
    const urlParams = new URLSearchParams(window.location.search);
    gameState.online.gameId = urlParams.get('game_id');
    gameState.mode = urlParams.get('mode') || 'online';
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const savedStats = localStorage.getItem('rps_stats');
    if (savedStats) {
        gameState.stats = JSON.parse(savedStats);
        updateStatsDisplay();
    }
}

// –û–Ω–ª–∞–π–Ω –∏–≥—Ä–∞
function connectToGame() {
    const input = document.getElementById('connectInput');
    const gameId = input.value.trim();
    
    if (gameId.length !== 6) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Game ID (6 —Ü–∏—Ñ—Ä)', 'error');
        return;
    }
    
    gameState.online.gameId = gameId;
    document.getElementById('gameId').textContent = gameId;
    document.getElementById('gameIdDisplay').classList.remove('hidden');
    document.getElementById('player2Status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
    
    showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...');
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã WebSocket –∏–ª–∏ API –∑–∞–ø—Ä–æ—Å
    // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ —Å–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    setTimeout(() => {
        document.getElementById('player2Status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞...';
        showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∏–≥—Ä–µ!');
    }, 1000);
}

function makeChoice(choice) {
    if (!gameState.online.gameId) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ', 'error');
        return;
    }
    
    gameState.online.playerChoice = choice;
    document.getElementById('player1Choice').textContent = getChoiceEmoji(choice);
    document.getElementById('player1Status').textContent = '–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω';
    
    // –ê–Ω–∏–º–∞—Ü–∏—è
    document.getElementById('player1Choice').classList.add('shake');
    setTimeout(() => {
        document.getElementById('player1Choice').classList.remove('shake');
    }, 500);
    
    // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ WebSocket)
    setTimeout(() => {
        const choices = ['rock', 'paper', 'scissors'];
        const opponentChoice = choices[Math.floor(Math.random() * choices.length)];
        gameState.online.opponentChoice = opponentChoice;
        
        document.getElementById('player2Choice').textContent = getChoiceEmoji(opponentChoice);
        document.getElementById('player2Status').textContent = '–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        showOnlineResult();
    }, 1500);
}

function showOnlineResult() {
    const result = determineWinner(
        gameState.online.playerChoice,
        gameState.online.opponentChoice
    );
    
    document.getElementById('resultPlayer1').textContent = 
        getChoiceEmoji(gameState.online.playerChoice);
    document.getElementById('resultPlayer2').textContent = 
        getChoiceEmoji(gameState.online.opponentChoice);
    
    let winnerText = '';
    if (result === 'draw') {
        winnerText = 'üéâ –ù–∏—á—å—è! üéâ';
    } else if (result === 'player1') {
        winnerText = 'üèÜ –í—ã –ø–æ–±–µ–¥–∏–ª–∏! üèÜ';
        gameState.stats.wins++;
    } else {
        winnerText = 'üíÄ –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏! üíÄ';
    }
    
    gameState.stats.games++;
    updateStats();
    
    document.getElementById('winnerText').textContent = winnerText;
    document.getElementById('onlineResult').classList.remove('hidden');
    
    // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∏–±—Ä–∞—Ü–∏—é)
    if (navigator.vibrate) {
        navigator.vibrate(200);
    }
}

// –õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞
function makeLocalChoice(choice) {
    if (gameState.local.currentPlayer === 1) {
        gameState.local.player1Choice = choice;
        document.getElementById('localPlayer1Choice').textContent = getChoiceEmoji(choice);
        document.getElementById('localPlayer1Status').textContent = '–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω';
        gameState.local.currentPlayer = 2;
        document.getElementById('localTurn').innerHTML = '–•–æ–¥: <span style="font-weight: bold;">–ò–≥—Ä–æ–∫ 2</span>';
        document.getElementById('localTurn').className = 'local-turn player2';
        document.getElementById('resetLocalBtn').classList.remove('hidden');
    } else {
        gameState.local.player2Choice = choice;
        document.getElementById('localPlayer2Choice').textContent = getChoiceEmoji(choice);
        document.getElementById('localPlayer2Status').textContent = '–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω';
        document.getElementById('revealLocalBtn').classList.remove('hidden');
    }
}

function revealLocalResult() {
    const result = determineWinner(
        gameState.local.player1Choice,
        gameState.local.player2Choice
    );
    
    document.getElementById('localResultPlayer1').textContent = 
        getChoiceEmoji(gameState.local.player1Choice);
    document.getElementById('localResultPlayer2').textContent = 
        getChoiceEmoji(gameState.local.player2Choice);
    
    let winnerText = '';
    if (result === 'draw') {
        winnerText = 'üéâ –ù–∏—á—å—è! üéâ';
    } else if (result === 'player1') {
        winnerText = 'üèÜ –ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ 1! üèÜ';
    } else {
        winnerText = 'üèÜ –ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ 2! üèÜ';
    }
    
    gameState.stats.games++;
    updateStats();
    
    document.getElementById('localWinnerText').textContent = winnerText;
    document.getElementById('localResult').classList.remove('hidden');
    document.getElementById('revealLocalBtn').classList.add('hidden');
    
    if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
    }
}

function resetLocalGame() {
    gameState.local = {
        player1Choice: null,
        player2Choice: null,
        currentPlayer: 1
    };
    
    document.getElementById('localPlayer1Choice').textContent = '‚ùì';
    document.getElementById('localPlayer2Choice').textContent = '‚ùì';
    document.getElementById('localPlayer1Status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞...';
    document.getElementById('localPlayer2Status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞...';
    document.getElementById('localTurn').innerHTML = '–•–æ–¥: <span style="font-weight: bold;">–ò–≥—Ä–æ–∫ 1</span>';
    document.getElementById('localTurn').className = 'local-turn player1';
    document.getElementById('localResult').classList.add('hidden');
    document.getElementById('revealLocalBtn').classList.add('hidden');
    document.getElementById('resetLocalBtn').classList.add('hidden');
}

function startNewLocalGame() {
    resetLocalGame();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getChoiceEmoji(choice) {
    const emojis = {
        'rock': 'ü™®',
        'paper': 'üìÑ',
        'scissors': '‚úÇÔ∏è'
    };
    return emojis[choice] || '‚ùì';
}

function determineWinner(choice1, choice2) {
    if (choice1 === choice2) return 'draw';
    
    const rules = {
        'rock': 'scissors',
        'scissors': 'paper',
        'paper': 'rock'
    };
    
    return rules[choice1] === choice2 ? 'player1' : 'player2';
}

function resetGame() {
    gameState.online.playerChoice = null;
    gameState.online.opponentChoice = null;
    
    document.getElementById('player1Choice').textContent = '‚ùì';
    document.getElementById('player2Choice').textContent = '‚ùì';
    document.getElementById('player1Status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞...';
    document.getElementById('player2Status').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞...';
    document.getElementById('onlineResult').classList.add('hidden');
}

function updateStats() {
    localStorage.setItem('rps_stats', JSON.stringify(gameState.stats));
    updateStatsDisplay();
}

function updateStatsDisplay() {
    document.getElementById('gamesPlayed').textContent = gameState.stats.games;
    document.getElementById('winsCount').textContent = gameState.stats.wins;
}

function showNotification(message, type = 'info') {
    const tg = window.Telegram.WebApp;
    tg.showPopup({
        title: type === 'error' ? '–û—à–∏–±–∫–∞' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        message: message
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
window.connectToGame = connectToGame;
window.makeChoice = makeChoice;
window.makeLocalChoice = makeLocalChoice;
window.revealLocalResult = revealLocalResult;
window.resetLocalGame = resetLocalGame;
window.startNewLocalGame = startNewLocalGame;
window.resetGame = resetGame;
window.copyGameId = copyGameId;
window.shareResult = shareResult;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
initGame();
